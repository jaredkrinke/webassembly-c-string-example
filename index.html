<html>
    <body>
        <p>Count of the letter "a" in the string "<span id="input">a string that has many letter a's</span>": <span id="result1">?</span></p>
        <p>Here's a string with <span id="input2">7</span> b's in it: "<span id="result2">?</span>"</p>

        <script type="module">
            (async () => {
                const buffer = await (await fetch("./string-example.wasm")).arrayBuffer();
                const module = await WebAssembly.instantiate(buffer);

                // Passing in a string
                const inputString = document.getElementById("input").innerText;
                const nullTerminatedString = inputString + "\0";
                const encodedString = (new TextEncoder()).encode(nullTerminatedString);
                const stringAddress = module.instance.exports.allocate(encodedString.length);
                try {
                    const destination = new Uint8Array(module.instance.exports.memory.buffer, stringAddress);
                    destination.set(encodedString);
                    const result = module.instance.exports.count_as(stringAddress);
                    document.getElementById("result1").innerText = result;
                } finally {
                    module.instance.exports.deallocate(stringAddress);
                }

                // Returning a string
                const count = parseInt(document.getElementById("input2").innerText);
                const address = module.instance.exports.write_bs(count);
                try {
                    const buffer = module.instance.exports.memory.buffer;
                    const encodedStringLength = (new Uint8Array(buffer, address)).indexOf(0);
                    const encodedStringBuffer = new Uint8Array(buffer, address, encodedStringLength);
                    const result = (new TextDecoder()).decode(encodedStringBuffer);
                    document.getElementById("result2").innerText = result;
                } finally {
                    module.instance.exports.deallocate(address);
                }
            })();
        </script>
    </body>
</html>
